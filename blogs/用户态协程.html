<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>用户态线程实现 | 可阿奇的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="整理面试和算法经验">
    
    <link rel="preload" href="./assets/css/0.styles.04d241ef.css" as="style"><link rel="preload" href="./assets/js/app.246248bb.js" as="script"><link rel="preload" href="./assets/js/7.2a236712.js" as="script"><link rel="preload" href="./assets/js/2.9f42ac56.js" as="script"><link rel="preload" href="./assets/js/1.b396ec45.js" as="script"><link rel="preload" href="./assets/js/58.9b9bdf6b.js" as="script"><link rel="prefetch" href="./assets/js/10.e02dc3f6.js"><link rel="prefetch" href="./assets/js/11.6e0e491c.js"><link rel="prefetch" href="./assets/js/14.bfc38c98.js"><link rel="prefetch" href="./assets/js/15.458199aa.js"><link rel="prefetch" href="./assets/js/16.1136fbe6.js"><link rel="prefetch" href="./assets/js/17.ceac0947.js"><link rel="prefetch" href="./assets/js/18.1eae56dd.js"><link rel="prefetch" href="./assets/js/19.1375a8b4.js"><link rel="prefetch" href="./assets/js/20.e183be87.js"><link rel="prefetch" href="./assets/js/21.13ae1da9.js"><link rel="prefetch" href="./assets/js/22.e50b5b46.js"><link rel="prefetch" href="./assets/js/23.5cb71428.js"><link rel="prefetch" href="./assets/js/24.bbe2a2e6.js"><link rel="prefetch" href="./assets/js/25.bff39149.js"><link rel="prefetch" href="./assets/js/26.0c7ef2c4.js"><link rel="prefetch" href="./assets/js/27.e62cad0f.js"><link rel="prefetch" href="./assets/js/28.f2f97c00.js"><link rel="prefetch" href="./assets/js/29.83809067.js"><link rel="prefetch" href="./assets/js/3.410f075f.js"><link rel="prefetch" href="./assets/js/30.17d86ce9.js"><link rel="prefetch" href="./assets/js/31.00f7b82c.js"><link rel="prefetch" href="./assets/js/32.f5f71880.js"><link rel="prefetch" href="./assets/js/33.a43d4f79.js"><link rel="prefetch" href="./assets/js/34.bf644636.js"><link rel="prefetch" href="./assets/js/35.cd750b5c.js"><link rel="prefetch" href="./assets/js/36.b5015032.js"><link rel="prefetch" href="./assets/js/37.2e2a055d.js"><link rel="prefetch" href="./assets/js/38.91a15dc1.js"><link rel="prefetch" href="./assets/js/39.54f4a11a.js"><link rel="prefetch" href="./assets/js/4.d37fdb5d.js"><link rel="prefetch" href="./assets/js/40.9063e86e.js"><link rel="prefetch" href="./assets/js/41.4a558526.js"><link rel="prefetch" href="./assets/js/42.2cc5fee3.js"><link rel="prefetch" href="./assets/js/43.5fe89715.js"><link rel="prefetch" href="./assets/js/44.9cd9558f.js"><link rel="prefetch" href="./assets/js/45.5605875b.js"><link rel="prefetch" href="./assets/js/46.c5cba4e2.js"><link rel="prefetch" href="./assets/js/47.dcd33ca3.js"><link rel="prefetch" href="./assets/js/48.da685e5c.js"><link rel="prefetch" href="./assets/js/49.cf0bd9a1.js"><link rel="prefetch" href="./assets/js/5.6a478b0c.js"><link rel="prefetch" href="./assets/js/50.65c75bb8.js"><link rel="prefetch" href="./assets/js/51.1d95097f.js"><link rel="prefetch" href="./assets/js/52.5ecb5af1.js"><link rel="prefetch" href="./assets/js/53.7513fa81.js"><link rel="prefetch" href="./assets/js/54.9d38e551.js"><link rel="prefetch" href="./assets/js/55.fe06dd1d.js"><link rel="prefetch" href="./assets/js/56.0da32ba0.js"><link rel="prefetch" href="./assets/js/57.aff7d286.js"><link rel="prefetch" href="./assets/js/6.5bb8d0e0.js"><link rel="prefetch" href="./assets/js/8.ab30a3bf.js"><link rel="prefetch" href="./assets/js/9.109e9053.js"><link rel="prefetch" href="./assets/js/vendors~docsearch.fea53d47.js">
    <link rel="stylesheet" href="./assets/css/0.styles.04d241ef.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>可阿奇的博客</h3> <p class="description" data-v-59e6cb88>整理面试和算法经验</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>可阿奇</span>
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><img src="./pic.jpg" alt="可阿奇的博客" class="logo"> <span class="site-name">可阿奇的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./categories/力扣/" class="nav-link"><i class="undefined"></i>
  力扣
</a></li><li class="dropdown-item"><!----> <a href="/./categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/./categories/随笔/" class="nav-link"><i class="undefined"></i>
  随笔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      我的
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/K-AQ" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://leetcode.cn/u/ke-a-qi/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/./tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="./pic.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    可阿奇
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>20</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>6</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./categories/力扣/" class="nav-link"><i class="undefined"></i>
  力扣
</a></li><li class="dropdown-item"><!----> <a href="/./categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/./categories/随笔/" class="nav-link"><i class="undefined"></i>
  随笔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      我的
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/K-AQ" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://leetcode.cn/u/ke-a-qi/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/./tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>用户态线程实现</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>可阿奇</span>
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">用户态线程实现</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>可阿奇</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2023/7/10</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>项目</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1. 概述</h1> <p>  所谓用户态线程就是把内核态的线程在用户态实现了一遍而已，目的是更轻量化（更少的内存占用、更少的隔离、更快的调度）和更高的可控性（可以自己控制调度器）。用户态所有东西内核态都「看得见」，只是对于内核而言「用户态线程」只是一堆内存数据而已。</p> <p>  线程并不是一个具体的名词，在不同语境下可以指代不同的东西，但都代表多个任务共享同一个 CPU。例如 Intel 的超线程技术可以让操作系统以为有两个核，在 CPU 层面通过共用原件来做到一个物理核执行两个逻辑核的任务；操作系统层面的线程就是所谓的「内核态线程」；「用户态线程」则多种多样，只要能满足在同一个内核线程上执行多个任务的都算，例如 coroutine、golang 的 goroutine、C# 的 Task。不要被名词所局限，他们其实是相同的东西。</p> <p>  用户态线程系统应该包含两个部分，一个部分是按内核代码原则设计用户态的线程库，由一系列的函数和以线程控制快TCB为核心的一系列数据结构组成；另一个部分是演示系统，调用线程库创建多线程的程序，使其并发执行，以展示系统的运行状态，显示系统的关键数据结构的内容。</p> <h1 id="_2-线程切换原理"><a href="#_2-线程切换原理" class="header-anchor">#</a> 2. 线程切换原理</h1> <p>  线程切换有两个要点。第1个要点是保存现场，第2个要点则是记录接下来需要执行的指令。我们需要细化的考虑一下——现场指的是什么，接下来需要执行的指令指的是什么，以及如何保存现场现场该保存在哪里？显而易见，“保存现场”则是保存CPU内部的寄存器状态。保存接下来需要执行的指令就是需要保存接下来要执行的指令的地址。这些内容该保存到哪里呢？当然是线程的栈里面。具体来说，线程的切换有以下几个要点：</p> <ul><li>我们需要为每一个线程设立一个独立的，互相不干扰的栈空间。</li> <li>当线程发生切换的时候，当前线程被切换之前，需要把自己的现场进行完好的保留，同时记录下下一条需要执行指令的指令地址。</li> <li>把CPU的栈顶指针寄存器esp切换到即将被调入的线程的堆栈的栈顶地址，完成了线程栈空间的切换。</li></ul> <p>  经过上述这几个步骤，我们便完成了线程的切换，由于上面的步骤需要直接访问CPU的寄存器，于是这个过程往往是采用汇编的方式来进行。</p> <h1 id="_3-系统结构和主要的算法设计思路"><a href="#_3-系统结构和主要的算法设计思路" class="header-anchor">#</a> 3. 系统结构和主要的算法设计思路</h1> <h2 id="_3-1-需要做的工作"><a href="#_3-1-需要做的工作" class="header-anchor">#</a> 3.1 需要做的工作</h2> <ol><li>建立描述线程的数据结构TCB；</li> <li>建立描述线程队列的数据结构tasks；</li> <li>通过调用thread_create函数创建线程；</li> <li>使用两种方式启动线程：</li></ol> <ul><li>通过调用函数detach实现线程的分离式启动（父线程不必等待子线程执行结束，可以继续执行）</li> <li>通过调用thread_join实现阻塞式启动（父调线程等待该子线程结束后才能继续执行）</li></ul> <ol start="5"><li>实现多种线程状态，线程状态表如下:</li></ol> <table><thead><tr><th style="text-align:center;">状态名称</th> <th style="text-align:center;">含义</th> <th style="text-align:center;">状态特点</th></tr></thead> <tbody><tr><td style="text-align:center;">THREAD_READY</td> <td style="text-align:center;">线程就绪</td> <td style="text-align:center;">线程正在运行</td></tr> <tr><td style="text-align:center;">THREAD_RUNNING</td> <td style="text-align:center;">线程可调度</td> <td style="text-align:center;">线程处于可调度队列，但暂时没有得到cpu资源</td></tr> <tr><td style="text-align:center;">THREAD_SLEEP</td> <td style="text-align:center;">线程睡眠</td> <td style="text-align:center;">线程会在睡眠时间内不参与线程的调度，保持沉默</td></tr> <tr><td style="text-align:center;">THREAD_BLOCK</td> <td style="text-align:center;">线程阻塞</td> <td style="text-align:center;">线程由于等待某个事件发生而阻塞，不接受cpu调度</td></tr> <tr><td style="text-align:center;">THREAD_STOP</td> <td style="text-align:center;">线程停止</td> <td style="text-align:center;">线程收到调控，停止运行</td></tr> <tr><td style="text-align:center;">THREAD_DISPOSED</td> <td style="text-align:center;">线程撤销</td> <td style="text-align:center;">线程的空间需要被撤销掉</td></tr></tbody></table> <ol start="6"><li>实现多线程的状态转换，通过一系列的线程状态转换函数来实现线程的状态切换，这些函数如下表所示：</li></ol> <table><thead><tr><th style="text-align:center;">函数名</th> <th style="text-align:center;">参数</th> <th style="text-align:center;">函数作用</th></tr></thead> <tbody><tr><td style="text-align:center;">resume</td> <td style="text-align:center;">int tid</td> <td style="text-align:center;">将标号为tid的线程状态设置为THREAD_RUNNING</td></tr> <tr><td style="text-align:center;">wait</td> <td style="text-align:center;">int tid</td> <td style="text-align:center;">将标号为tid的线程状态设置为THREAD_BLOCK</td></tr> <tr><td style="text-align:center;">mysleep</td> <td style="text-align:center;">int tid</td> <td style="text-align:center;">将标号为tid的线程状态设置为THREAD_SLEEP</td></tr> <tr><td style="text-align:center;">dispose</td> <td style="text-align:center;">int tid</td> <td style="text-align:center;">将标号为tid的线程状态设置为 THREAD_DISPOSED</td></tr> <tr><td style="text-align:center;">remove_th</td> <td style="text-align:center;">int tid</td> <td style="text-align:center;">将标号为tid的线程状态设置为 THREAD_STOP</td></tr></tbody></table> <ol start="7"><li>实现多线程的切换，线程的切换需要通过汇编来完成。因此需要编写汇编代码完成线程上下文的切换。线程切换的方式有两种，第一种时主动切换，调用schedule完成到切换到指定线程的任务；另外一种则是根据线程调度来完成切换，当线程需要调度时，自动完成线程切换；</li> <li>实现线程的调度算法。本次设计的线程库采用了时间片轮转调度算法，该算法根据线程优先级为每个线程设置了时间片，使得每一个线程都能有相对公平的机会得到系统资源。</li></ol> <h2 id="_3-2-算法设计的一些细节"><a href="#_3-2-算法设计的一些细节" class="header-anchor">#</a> 3.2 算法设计的一些细节</h2> <p>  我们需要提几个问题，反反复考虑相关的实现细节之后再进行编码实现，这样会极大的提高我们编码的效率。</p> <h3 id="_3-2-1-如何设计线程的栈空间"><a href="#_3-2-1-如何设计线程的栈空间" class="header-anchor">#</a> 3.2.1 如何设计线程的栈空间？</h3> <p>  我们可以通过动态分配一个连续的地址空间来作为线程的栈空间。</p> <h3 id="_3-2-2-如何保留cpu当前执行指令的下一条指令地址"><a href="#_3-2-2-如何保留cpu当前执行指令的下一条指令地址" class="header-anchor">#</a> 3.2.2 如何保留CPU当前执行指令的下一条指令地址？</h3> <p>  通过call指令来完成对对下一条指令地址的保存，这里是对call指令一个非常巧妙的使用方法，需要非常丰富的编程经验以及对计算机汇编语言的升入理解。下面将详细讲解这一点。</p> <p>  前面已经分析过了，我们需要设计两种线程切换的方式，即主动切换和时钟中断切换。主动切换需要当前线程调用调度函数schedule来完成，而时钟中断切换则是通过设置时钟中断，中断后执行schedule函数来完成。我们分别考虑这两种情况下该如何保留下一条指令的地址。提前说明：switch（tid）为一个汇编函数，作用为切换到tid线程。</p> <ol><li>主动调度</li></ol> <p>  当线程主动调度的时候，线程1调用switch函数切换到线程2，当线程1执行了call switch指令后，线程1的栈空间如下图所示：
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA8cAAACRCAYAAADuMMotAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAATxSURBVHhe7d2BTepQAIVhN2ABFoABGIA3QAdhENlDF8E96iQk9yEPtJXK04RyG8/3J18IpR3gpAUeiiRJkiRJ4RnHkiRJkqT43sdx27YAAAAQo1tvHEuSJEmSlJBxLEmSJEmKzziWJEmSJMVnHEuSJEmS4jOOJUmSJEnxGceSJEmSpPiMY0mSJElSfMaxJEmSJCk+41iSJEmSFJ9xLEmSJEmKzziWJEmSJMVnHEuSJEmS4jOOJUmSJEnxGceSJEmSpPiMY0mSJElSfMaxJEmSJCm+q+MYAAAAUnTr3zl+OLwFAACAX844BgAAIJ5xDAAAQDzjGAAAgHjGMQAAAPGMYwAAAOIZxwAAAMQzjgEAAIhnHAMAABDPOAYAACCecQwAAEA84xgAAIB4xjEAAADxjGMAqKRdrkvzZ1Hagc8AgPsyjgEAAIhnHAMAABDPOAaASnqPVc8WZdOsy/P87bUpzcl2fnkdAHB7xjEAVHI5jt8G8WEgz07nzFcGMgDciXEMAJUMjePNctY7Z7c6DGY/2gUAozOOAaCSwceqz3eNz453j1dl1z0GANyccQwAlRjHADAdxjEAVPKdcXw8xzgGgNEZxwBQybe/c7ya944BALdnHANAJUPj+PLXqgcetQYAbs44BoBKhsbxdnkeyZ+GMgAwKuMYAKbgPI79pzEAVGEcA8AUGMcAUJVxDABTYBwDQFXGMQAAAPGMYwAAAOIZxwAAAMQzjgEAAIhnHAMAABDPOAYAACCecQwAAEA84xgAAIB4xjEAAADxjGMAAADiGccAAADEM44BAACId3UcAwAAQIpuvXH87y0AAAD8bsYxAAAA8YxjAAAA4hnHAAAAxDOOAQAAiGccAwAAEM84BgAAIJ5xDAAAQDzjGAAAgHjGMQAAAPGMYwAAAOIZxwAAAMQzjgEAAIhnHANAdbPyvGlK03zYvgydBwCMxTgGgKpOw3izKO352MvKQAaAOzOOAaCm10XZNOvy/No/vnv8NJgBgFEZxwAwQe3T2jgGgDsyjgFgck6PWj/OBz4DAMZgHAPA1PjOMQDcnXEMAFNy/A6yu8YAcG/GMQBMhWEMANUYxwAwBYYxAFRlHANAbYYxAFRnHANAVfOyNYwBoDrjGAAqOv6f8ds4HrQqu4FrAIDbM44BAACIZxwDAAAQzzgGAAAgnnEMAABAPOMYAACAeMYxAAAA8YxjAAAA4hnHAAAAxDOOAQAAiGccAwAAEM84BgAAIJ5xDAAAQDzjGAAAgHjGMQAAAPGMYwAAAOJdHccAAACQoltvHHdXNAAAAPxWxjEAAADxjGMAAADiGccAAADEM44BAACIZxwDAAAQzzgGAAAgnnEMAABAPOMYAACAeMYxAAAA8YxjAAAA4hnHAAAAxDOOAQAAiGccAwAAEM84BgAAIJ5xDAAAQDzjGAAAgHjGMQAAAPGMYwAAAOIZxwAAAMQzjgEAAIhnHAMAABDPOAYAACCecQwAAEA84xgARrB7bEqzWZT2P8fap/XFsa/O/cn1AMDPGMcAAADEM44BAACIZxwDAAAQzzgGAAAgnnEMAABAPOMYAACAeMYxAAAA8YxjAAAA4hnHAAAAxDOOAQAAiGccAwAAEM84BgAAIJ5xDAAAQDzjGAAAgHjGMQAAAPGujmMAAABI0e19HO/3ewAAAIjRzTgGAAAg0kel/AUfmqYpDTWeewAAAABJRU5ErkJggg==" alt="线程1的栈空间标"></p> <p>ip则保留了switch 函数执行完成后需要执行的指令地址，也即为下一条指令的地址。当线程1完成了现场的保存后，线程1的栈空间如下图所示：
<img src="data:image/png;base64,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" alt="现场保存后线程1的栈空间"></p> <p>最后，将esp保存到TCB中即可。当线程1重新被调入执行的时候，只需要将esp切换为tcb中保存的esp， 这样便完成了线程栈空间的切换，然后switch函数将会执行回复线程的操作，将线程1栈中的状态一一弹出，最后esp指向了ip，然后ret操作之后， 线程1便恢复了原来的执行状态。</p> <ol start="2"><li>时间片结束中断调度</li></ol> <p>  线程1在执行过程中时间片执行结束，产生中断，执行中断处理函数 schedule，schedule函数会从线程队列tasks中挑选一个最合适的线程，然后将其调入cpu执行。因此，当中断产生后，线程1的栈变成如下状态，首先是保存线程状态（中断基操）。
<img src="data:image/png;base64,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" alt="中断后线程1的栈"></p> <p>注意，此处的ip为中断前线程下一条指令的地址。接下来，线程1响应中断，call schedule（实际响应中段并不是call，此处为简化描述暂记为call）之后线程1的栈为：
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA70AAAJUCAYAAADZ4UFSAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAB8pSURBVHhe7d3hcRrrsgXQk4ECeCQgB6AA5AAIhECsPKxE5DzkSG7VPEH3tGZgQEggH6vP2lWrzgYG3ft31zeM/xlEREREREREmsboFRERERERkbap0fv8/AwAAAAtjJmNXhEREREREZFOMXpFRERERESkbYxeERERERERaRujV0RERERERNrG6BUREREREZG2MXpFRERERESkbYxeERERERERaRujV0RERERERNrG6BUREREREZG2MXpFRERERESkbYxeERERERERaRujV0RERERERNrG6BUREREREZG2MXpFRERERESkbYxeERERERERaRujV0RERERERNpmNnoBAACggzF7J73blwAAAPDVRaoZvQAAAPQRqWb0AgAA0EekmtELAABAH5FqRi8AAAB9RKoZvQAAAPQRqWb0AgAA0EekmtELAABAH5FqRi8AAAB9RKoZvQAAAPQRqWb0AgAA0EekmtELAABAH5FqRi8AAAB9RKoZvQDwRfy+HTbru+Fp6TMAIEWqGb0A8BWshof1elgbvQDwhkg1oxcA/nK/7l7G7nbwGr0A8LZINaMXAD5od7vxOEZf/FgdXPP0Y/L51uZ2eM7Pnn/e7957+DX5Tg7czc+bg9dxvdELAKdFqhm9APABOXhrnA43w+NmPmp3g3fyum5Rnozj+TWHn08ZvQBwjkg1oxcA3u9w0L7IIRwntzFgZ6e4L44N4e14jlPh46PW6AWAc0SqGb0A8F6vQ3X+fpz2Hr6fJ7ijvbE83ua8tT+Sp4xeADhHpJrRCwDvtTdi94yjN05uUw7dxRPi8e8dvD9n9ALAOSLVjF4AeK9jJ70Ts1udXy2N3uk4PvU3jV4AOEekmtELAO+VD606eOBUjOHd0N09dXl/oC6c6ObTmbffiVF7Pzz+nn7nldELAOeIVDN6AeADDp7evHeKe+zz7eit4bo/ng+fAD1l9ALAOSLVjF4A+KActuOtyQdjNU9xy8u4nZ7mxgjeO9kd/+bCP1tk9ALAOSLVjF4AAAD6iFQzegEAAOgjUs3oBQAAoI9INaMXAACAPiLVjF4AAAD6iFQzegEAAOgjUs3o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" alt="call后线程1的栈"></p> <p>注：上图中红色部分为中断前保留的线程1现场，黄色部分为现场切换前保留的现场，dest_id为schedule选出的需要被调入执行的目标线程id，而ip1则为中断服务程序调用schedule并执行玩成后需要执行的下一条指令的地址。故由上可知，当线程1重新被调入时，线程切换部分（黄色部分）的现场保留与恢复上文已经说过，不再赘述，而黄色部分的现场被恢复后，紧接着就是中断现场的恢复了——红色部分的状态被恢复，也就是恢复到了线程1中断前的状态，使得线程1最终恢复到了原来的状态。</p> <h1 id="_4-主要数据结构"><a href="#_4-主要数据结构" class="header-anchor">#</a> 4. 主要数据结构</h1> <h2 id="_4-1-线程控制块tcb"><a href="#_4-1-线程控制块tcb" class="header-anchor">#</a> 4.1 线程控制块TCB</h2> <p>  线程控制块（Thread Control Block，TCB）是与进程的控制块（PCB）相似的子控制块，只是TCB中所保存的线程状态比PCB中保存少而已。在用户态线程库中TCB是线程存在的唯一证明，通过控制TCB中的数据,我们可以对线程的状态等一系列的事务进行操作。因此TCB是线程的核心数据结构。据此，我们设计出了以下数据结构作为TCB。如下所示是TCB的数据结构：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{</span>
 
  <span class="token keyword">int</span> id<span class="token punctuation">;</span>  <span class="token comment">//线程的标识符</span>
 
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>th_fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//指向线程函数的函数指针</span>
 
  <span class="token keyword">int</span> esp<span class="token punctuation">;</span> <span class="token comment">//用来在发生线程切换是保存线程的栈顶地址</span>
 
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> wakeuptime<span class="token punctuation">;</span> <span class="token comment">// 线程唤醒时间</span>
 
  <span class="token keyword">int</span> status<span class="token punctuation">;</span> <span class="token comment">// 线程状态</span>
 
  <span class="token keyword">int</span> counter<span class="token punctuation">;</span> <span class="token comment">// 时间片</span>
 
  <span class="token keyword">int</span> priority<span class="token punctuation">;</span> <span class="token comment">// 线程优先级</span>
 
  <span class="token keyword">int</span> stack<span class="token punctuation">[</span>STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//现场的栈空间</span>
 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>task_struct即为TCB，此处只是命名不同而已。TCB中各个数据的详细作用已经标注在了上图中，但是，仍然有一些地方需要我们特别注意。th_fn为指向函数的指针，我们传入该参数的时候，需要把函数的地址以整数的形式传入。esp则记录了栈顶，一开始初始化的时候，stack栈中预先保存好了现场的初始状态以便线程进行调度，而esp初始时则指向了stack的栈顶，初始stack如下图所示：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// eflags</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// eax</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// edx</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// ecx</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// ebx</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// esi</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// edi</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// old ebp  </span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>start<span class="token punctuation">;</span> <span class="token comment">// ret to start   线程第一次被调度时会在此启动</span>
 
  <span class="token comment">// start 函数栈帧，刚进入 start 函数的样子 </span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token comment">// ret to unknown，如果 start 执行结束，表明线程结束 </span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>tsk<span class="token punctuation">;</span> <span class="token comment">// start 的参数</span>
</code></pre></div><p>由上可知，在初始化线程的时候，我们需要在stack中设置好线程上下文的初始环境，同时传入start函数的地址作为启动函数的地址。</p> <p>  wakeuptime是做什么用的呢？wakeuptime指定的线程从睡眠状态并唤醒的时间点。当线程调用sleep函数之后，wakeuptime便被设置为当前的时间加上线程需要休眠的时间，同时线程的状态被设置为thread_sleep。当线程发生调度的时候，调度函数会检查每一个处于睡眠状态的线程，如果当前的时间大于wakeuptime则将其状态设置为THREAD_RUNNING，重新参与现场的调度。</p> <p>  另外要注意的是，counter是如何发挥作用的呢？我们为每一个线程设定了一定数量的时间片，counter记录了线程当前还有多少时间片，每一个时间片都是一个单位的时间，比如说10毫秒。每一个时间片结束都会发生一次调度中断，这个中断的中断服务子程序会检查当前线程的counter是否小于0，如果小于零则代表当前线程的时间片用完了而需要进行线程的调度，调度算法会从线程队列中寻找另外一个可调度的而且counter大于0且counter最大的线程进行调度，否则的话直接结束中断。</p> <p>  priority代表着线程的优先级，当所有的县城时间片都已经用完的时候，需要重新为每一个线程分配时间片。每一个行程卡分配多少的时间变得这个就由priority来决定。优先级高的线程能够分配到更多的时间片，而优先级低的线程分配到时间片就相对的少，这样便实现了线程之间的优先级，让优先级高的线程能够得到更多的CPU处理时间，而线程优先级低的线程CPU处理时间则相对较少。</p> <h2 id="_4-2-线程队列"><a href="#_4-2-线程队列" class="header-anchor">#</a> 4.2 线程队列</h2> <p>  TCB的设计仅仅是针对于每一个线程来进行设计的,我们还需要一个数据结构来将所有的线程集合起来，让调度算法可以对其进行统一的操作。这个数据结构便是线程队列。队列有以下特点：</p> <ol><li><p>队列的容量一旦在构造时指定，后续不能改变；</p></li> <li><p>插入元素时，在队尾进行；删除元素时，在队首进行；</p></li> <li><p>队列满时，插入元素会阻塞线程；队列空时，删除元素也会阻塞线程；</p></li> <li><p>支持公平/非公平策略，默认为非公平策略（上一节讲述了更具counter值的大小进行调度）。</p></li></ol> <p>同时，队列应该是多队列，包括阻塞队列，就绪队列，睡眠队列等，然而本设计只设计一个队列就完成了所有队列的功能，其巧妙之处就在于，在线程的TCB中我们设置了一个线程状态标志，调度算法根据这个标识就能够进行合理的调度了。具体，该线程的队列设计如下：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> init_task <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>THREAD_RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>current <span class="token operator">=</span> <span class="token operator">&amp;</span>init_task<span class="token punctuation">;</span>
 
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>task<span class="token punctuation">[</span>NR_TASKS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">&amp;</span>init_task<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>init_task代表的是当前的主线程,其线程id为0。</p> <h1 id="_5-主要流程的程序实现"><a href="#_5-主要流程的程序实现" class="header-anchor">#</a> 5. 主要流程的程序实现</h1> <h2 id="_5-1-线程的创建"><a href="#_5-1-线程的创建" class="header-anchor">#</a> 5.1 线程的创建</h2> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">thread_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>tid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>start_routine<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
  <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
  <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>tsk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">++</span>id <span class="token operator">&lt;</span> NR_TASKS <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> NR_TASKS<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
  task<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> tsk<span class="token punctuation">;</span>
 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tid<span class="token punctuation">)</span> <span class="token operator">*</span>tid <span class="token operator">=</span> id<span class="token punctuation">;</span>  <span class="token comment">//返回值</span>
 
  tsk<span class="token operator">-&gt;</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
 
  tsk<span class="token operator">-&gt;</span>th_fn <span class="token operator">=</span> start_routine<span class="token punctuation">;</span>
 
  <span class="token keyword">int</span> <span class="token operator">*</span>stack <span class="token operator">=</span> tsk<span class="token operator">-&gt;</span>stack<span class="token punctuation">;</span> <span class="token comment">// 栈顶界限</span>
  tsk<span class="token operator">-&gt;</span>esp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>stack<span class="token operator">+</span>STACK_SIZE<span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  tsk<span class="token operator">-&gt;</span>wakeuptime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
  tsk<span class="token operator">-&gt;</span>status <span class="token operator">=</span> THREAD_STOP<span class="token punctuation">;</span>
 
  tsk<span class="token operator">-&gt;</span>counter <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
 
  tsk<span class="token operator">-&gt;</span>priority <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
 
  <span class="token comment">// 初始 switch_to 函数栈帧</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// eflags</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// eax</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// edx</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// ecx</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// ebx</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// esi</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// edi</span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// old ebp  </span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>start<span class="token punctuation">;</span> <span class="token comment">// ret to start   线程第一次被调度时会在此启动</span>
 
  <span class="token comment">// start 函数栈帧，刚进入 start 函数的样子 </span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token comment">// ret to unknown，如果 start 执行结束，表明线程结束 </span>
 
  stack<span class="token punctuation">[</span>STACK_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>tsk<span class="token punctuation">;</span> <span class="token comment">// start 的参数</span>
 
  <span class="token comment">/*
 
  汇编函数调用,c风格参数传递
 
  传入参数分别是IP,c1,c2
 
  */</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-2-线程调度"><a href="#_5-2-线程调度" class="header-anchor">#</a> 5.2 线程调度</h2> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
   <span class="token comment">//线程的调度函数</span>
 
    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>next <span class="token operator">=</span> <span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
      <span class="token function">switch_to</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//线程的上下文切换</span>
 
    <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
 
 
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
<span class="token comment">/*找到时间片最大的线程进行调度*/</span>
 
  <span class="token keyword">int</span> i<span class="token punctuation">,</span> next<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
 
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_TASKS<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span>
 
    <span class="token keyword">if</span><span class="token punctuation">(</span> task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status <span class="token operator">==</span> THREAD_EXIT<span class="token punctuation">)</span><span class="token punctuation">{</span>
 
      <span class="token keyword">if</span><span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span>current<span class="token punctuation">)</span>
 
        <span class="token function">remove_th</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
 
    <span class="token punctuation">}</span>
 
  
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status <span class="token operator">==</span> THREAD_DISPOSED<span class="token punctuation">)</span>
 
   <span class="token punctuation">{</span>
 
     <span class="token keyword">if</span><span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span>current<span class="token punctuation">)</span>
 
      <span class="token function">remove_th</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
     <span class="token keyword">continue</span><span class="token punctuation">;</span>
 
   <span class="token punctuation">}</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status <span class="token operator">!=</span> THREAD_STOP<span class="token operator">&amp;&amp;</span> task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status <span class="token operator">!=</span> THREAD_BLOCK
 
        <span class="token operator">&amp;&amp;</span> <span class="token function">getmstime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>wakeuptime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
      task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status <span class="token operator">=</span> THREAD_RUNNING<span class="token punctuation">;</span>
 
    <span class="token punctuation">}</span>
 
  <span class="token punctuation">}</span>
 
  <span class="token comment">//上面的作用是唤醒睡眠的线程,使其可以接受调度</span>
 
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
    c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
    next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_TASKS<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
 
      <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status <span class="token operator">==</span> THREAD_RUNNING <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>counter <span class="token operator">&gt;</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
        c <span class="token operator">=</span> task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>counter<span class="token punctuation">;</span>
 
        next <span class="token operator">=</span> i<span class="token punctuation">;</span>
 
      <span class="token punctuation">}</span>
 
    <span class="token punctuation">}</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 如果所有任务时间片都是 0，重新调整时间片的值</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_TASKS<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
        <span class="token keyword">if</span><span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
          task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>counter <span class="token operator">=</span> task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>priority <span class="token operator">+</span> <span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>counter <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
      <span class="token punctuation">}</span>
 
    <span class="token punctuation">}</span>
 
  <span class="token punctuation">}</span>
 
  
 
  <span class="token keyword">return</span> task<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-3-线程上下文切换"><a href="#_5-3-线程上下文切换" class="header-anchor">#</a> 5.3 线程上下文切换</h2> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token punctuation">.</span>section <span class="token punctuation">.</span>text
 
<span class="token punctuation">.</span>global switch_to
 
switch_to<span class="token operator">:</span>
 
  call closealarm <span class="token comment">/* 模拟关中断 */</span>
 
  push <span class="token operator">%</span>ebp
 
  mov <span class="token operator">%</span>esp<span class="token punctuation">,</span> <span class="token operator">%</span>ebp <span class="token comment">/* 更改栈帧，以便寻参 */</span>
 
  <span class="token comment">/* 保存现场 */</span>
 
    push <span class="token operator">%</span>edi
 
    push <span class="token operator">%</span>esi
 
    push <span class="token operator">%</span>ebx
 
    push <span class="token operator">%</span>edx
 
    push <span class="token operator">%</span>ecx
 
    push <span class="token operator">%</span>eax
 
  pushfl
 
  <span class="token comment">/* 准备切换栈 */</span>
 
  mov current<span class="token punctuation">,</span> <span class="token operator">%</span>eax <span class="token comment">/* 取 current 基址放到 eax     */</span>
 
  mov <span class="token operator">%</span>esp<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>eax<span class="token punctuation">)</span> <span class="token comment">/* 保存当前 esp 到线程结构体 */</span> 
 
  mov <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>ebp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>eax <span class="token comment">/* 8(%ebp)即为c语言的传入参数next   取下一个线程结构体基址*/</span>
 
  mov <span class="token operator">%</span>eax<span class="token punctuation">,</span> current <span class="token comment">/* 更新 current */</span>
 
    mov <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>eax<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>esp <span class="token comment">/* 切换到下一个线程的栈 */</span>
 
  <span class="token comment">/* 恢复现场, 到这里，已经进入另一个线程环境了，本质是 esp 改变 */</span>
 
  popfl
 
    popl <span class="token operator">%</span>eax
 
    popl <span class="token operator">%</span>ecx
 
    popl <span class="token operator">%</span>edx
 
    popl <span class="token operator">%</span>ebx
 
 
    popl <span class="token operator">%</span>esi
 
    popl <span class="token operator">%</span>edi
 
    popl <span class="token operator">%</span>ebp
 
  call openalarm <span class="token comment">/* 模拟开中断  */</span>
 
ret
</code></pre></div><h2 id="_5-4-thread-join-阻塞式线程启动"><a href="#_5-4-thread-join-阻塞式线程启动" class="header-anchor">#</a> 5.4 thread_join——阻塞式线程启动</h2> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">thread_join</span><span class="token punctuation">(</span><span class="token keyword">int</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
  <span class="token keyword">while</span><span class="token punctuation">(</span>task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span>task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status <span class="token operator">!=</span> THREAD_EXIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
      <span class="token keyword">if</span><span class="token punctuation">(</span>task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status<span class="token operator">==</span>THREAD_STOP<span class="token punctuation">)</span><span class="token punctuation">{</span>
 
          task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status<span class="token operator">=</span>THREAD_RUNNING<span class="token punctuation">;</span>
 
      <span class="token punctuation">}</span>
 
    <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-5-detach-分离式线程启动"><a href="#_5-5-detach-分离式线程启动" class="header-anchor">#</a> 5.5 detach——分离式线程启动</h2> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">detach</span><span class="token punctuation">(</span><span class="token keyword">int</span> tid<span class="token punctuation">)</span><span class="token punctuation">{</span>
 
 
  <span class="token keyword">if</span><span class="token punctuation">(</span>task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status<span class="token operator">==</span>THREAD_STOP<span class="token operator">&amp;&amp;</span> task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status<span class="token operator">!=</span>THREAD_EXIT<span class="token punctuation">)</span><span class="token punctuation">{</span>
 
    task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status<span class="token operator">=</span>THREAD_RUNNING<span class="token punctuation">;</span>
 
    <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-6-等待子线程执行结束而阻塞父线程"><a href="#_5-6-等待子线程执行结束而阻塞父线程" class="header-anchor">#</a> 5.6 等待子线程执行结束而阻塞父线程</h2> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">wait_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 
<span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
 
<span class="token keyword">int</span> remain<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
 
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 
  remain<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
 
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>NR_TASKS<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 
<span class="token keyword">if</span><span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status<span class="token operator">!=</span>THREAD_EXIT<span class="token punctuation">)</span><span class="token punctuation">{</span>
 
   remain<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
 
   <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   <span class="token keyword">break</span><span class="token punctuation">;</span>
 
   <span class="token keyword">continue</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
 
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>remain<span class="token punctuation">)</span><span class="token punctuation">{</span>
 
  <span class="token keyword">break</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
 
<span class="token keyword">void</span> <span class="token function">wait_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> tid<span class="token punctuation">)</span><span class="token punctuation">{</span>
 
<span class="token keyword">while</span> <span class="token punctuation">(</span>task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span>task<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token operator">-&gt;</span>status <span class="token operator">!=</span> THREAD_EXIT<span class="token punctuation">)</span>
 
<span class="token punctuation">{</span>
 
  <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
</code></pre></div><h1 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h1> <p><a href="https://blog.csdn.net/qq_42659989/article/details/119345832" target="_blank" rel="noopener noreferrer">用户态线程库原理、设计与实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_3-1-需要做的工作" class="sidebar-link reco-side-_3-1-需要做的工作" data-v-b57cc07c>3.1 需要做的工作</a></li><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_3-2-算法设计的一些细节" class="sidebar-link reco-side-_3-2-算法设计的一些细节" data-v-b57cc07c>3.2 算法设计的一些细节</a></li><li class="level-3" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_3-2-1-如何设计线程的栈空间" class="sidebar-link reco-side-_3-2-1-如何设计线程的栈空间" data-v-b57cc07c>3.2.1 如何设计线程的栈空间？</a></li><li class="level-3" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_3-2-2-如何保留cpu当前执行指令的下一条指令地址" class="sidebar-link reco-side-_3-2-2-如何保留cpu当前执行指令的下一条指令地址" data-v-b57cc07c>3.2.2 如何保留CPU当前执行指令的下一条指令地址？</a></li><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_4-1-线程控制块tcb" class="sidebar-link reco-side-_4-1-线程控制块tcb" data-v-b57cc07c>4.1 线程控制块TCB</a></li><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_4-2-线程队列" class="sidebar-link reco-side-_4-2-线程队列" data-v-b57cc07c>4.2 线程队列</a></li><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_5-1-线程的创建" class="sidebar-link reco-side-_5-1-线程的创建" data-v-b57cc07c>5.1 线程的创建</a></li><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_5-2-线程调度" class="sidebar-link reco-side-_5-2-线程调度" data-v-b57cc07c>5.2 线程调度</a></li><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_5-3-线程上下文切换" class="sidebar-link reco-side-_5-3-线程上下文切换" data-v-b57cc07c>5.3 线程上下文切换</a></li><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_5-4-thread-join-阻塞式线程启动" class="sidebar-link reco-side-_5-4-thread-join-阻塞式线程启动" data-v-b57cc07c>5.4 thread_join——阻塞式线程启动</a></li><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_5-5-detach-分离式线程启动" class="sidebar-link reco-side-_5-5-detach-分离式线程启动" data-v-b57cc07c>5.5 detach——分离式线程启动</a></li><li class="level-2" data-v-b57cc07c><a href="/./blogs/%E7%94%A8%E6%88%B7%E6%80%81%E5%8D%8F%E7%A8%8B.html#_5-6-等待子线程执行结束而阻塞父线程" class="sidebar-link reco-side-_5-6-等待子线程执行结束而阻塞父线程" data-v-b57cc07c>5.6 等待子线程执行结束而阻塞父线程</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="./assets/js/app.246248bb.js" defer></script><script src="./assets/js/7.2a236712.js" defer></script><script src="./assets/js/2.9f42ac56.js" defer></script><script src="./assets/js/1.b396ec45.js" defer></script><script src="./assets/js/58.9b9bdf6b.js" defer></script>
  </body>
</html>
